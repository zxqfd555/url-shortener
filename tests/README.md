# Тестирование

Два типа тестирования: тестируем корректность (сервис ведет себя как надо) и тестируем нагрузочно (какой рейт сервис держит).

## Тесты корректности

Файл test_correctness_all.py. Чтоб запустить надо библиотека requests.

Проверяем, что продление ссылок работает. Для этого создаем ссылку с TTL равным 10 секунд и ходим по ней каждую секунду в течении 150 секунд. Удостоверяемся, что код ответа всегда 200. Строго говоря, конечно, 302. Но и браузер и Python requests видя 302 сразу редиректят на оригинальный урл и там уже вернут 200, сходив по нему.

Проверяем, что протухание ссылок работает. Для этого создаем ссылку с TTL равным 10 секунд, 20 секунд по ней не ходим, после чего делаем запрос. Убеждаемся, что там 404.

## Нагрузочные тесты

### Очень много переходов по ссылке

Ссылки на графики и генератор есть в load/get_one_long_link.

Это самый благоприятный кейс.

Запускаем на большом рейте запросов, чтобы сервис упал: https://overload.yandex.net/128226. При падении уперлись в CPU, что видно на графике в Monitoring.

Берем порог, который был незадолго до падения - 7000 RPS. Запускаем с этим постоянным рейтом стрельбу. Результат - работает стабильно. График: https://overload.yandex.net/128228

Итого, без кэширования, а просто долблением монги получилось выжать 7000 RPS, причем с небольшим запасом по CPU.

Начал с 2K RPS. Шаги по оптимизации:
  - Выключил весь логгинг.
  - Эксперименты с размером пула коннектов к монге.
  - Раз уж демон и access log живут в одном процессе, давайте вести лог не построчно, а храня map из slug-а во время последнего посещения.

### Очень много write-ов

Сервис валится на 1500 RPS: https://overload.yandex.net/128254. В конечном итоге упираемся в CPU, но в данном случае это не главная проблема.

Можно понизить рейт до 800-900 RPS и проблемы все равно будут. Причина: быстро скапливается очередь на то, чтобы записать в базу (а записи медленнее чтений). В конечном итоге очередь будет только расти, потому что количества тредов в сервере не хватит, чтобы ее своевременно растаскивать.

Попытка решения: увеличить число тредов в сервере. Не помогло: при большем количестве тредов начинает всплывать много context switch-ей, из-за чего работа тормозит еще больше. График: https://overload.yandex.net/128558.

Стабильной работы стоит ожидать на 300 RPS. График: https://overload.yandex.net/128265.

Но и ладно. И так мы знали, что долбить базу write-ами плохая идея. Вот еще раз экспериментально в этом убедились.

Кажется, что это не совсем real-life кейс. Все таки, в сокращалках сильно чаще по ссылке переходят, что постят новую. Иначе, для кого вообще их постят.

### Имитация "реального мира"

Ссылки на графики и генератор есть в load/real_world.

Нормально сымитировать, на самом деле, сложно.

Делаем 1% запросов на запись и 99% запросов на чтение. Читаем какое-то небольшое множество страниц, потому что кейс посещения за 5-10 секунд  __всех__ страниц коллекции - что-то странное. Берем id страниц из Пуассоновского распределения.

Еще одна проблема: нам в патронах надо знать заранее URL, который сгенерируется. А мы не можем, он рандомный. Чтобы это обойти, реализовал интерфейс генераторов slug-ов и использовал Sequential: https://github.com/zxqfd555/url-shortener/blob/master/src/lib/slug.h#L32

По итогу вышло неплохо. Создалось за три минуты около 10 тысяч страниц и посетилось довольно много - сотни тысяч. Все ломается на около 6К из-за CPU, но брал рейт с запасом: выбрал 4K. На нем несколько запусков работают уверенно хорошо: 10-20 ms в 98 перцентили в пике.

Стельба большой нагрузкой и упирание в CPU: https://overload.yandex.net/128374
Стрельба нагрузкой в 4K RPS и стабильная работа: https://overload.yandex.net/128373. Всплески незначительны - 20 ms в 98-перцентили. Вероятные причины - запуск демона и внутренние процессы монги, в которую пишут с неплохим рейтом.

## Выводы по итогу нагрузочного тестирования

Хорошо, что сделали схему с демоном и продлением ссылок: второй тест показал, что без нее остановились бы на сотнях RPS - был бы write на каждый запрос. Схема с демоном позволила на реальном кейсе держать на одном инстансе рейт около 4K - заметно лучше.

В каких-то идеальных случаях можно держать до 7K, но не уверен, что это особо показательно. Надо исходить из планируемой нагрузки и возможно в дальнейших тестах уменьшать еще больше число write-ов, но все же не убирать их вовсе.

4-5 минут нам хватает, потому что неординарную нагрузку, дополнительную к обычной нам может дать только запуск демона. Он запускается раз в 90 секунд, следовательно, мы переживаем примерно три таких пика.
